
# 场外的Daily盈亏计算

## 1.过滤得到T日的持仓， 当日到期，当日成交

台账是个总帐，包含历史的，包含当下的。T日可以任意指定。既可以是当日，也可以是历史上的某一日。

### 1.1 T日的持仓

从台账中，删选出T日还在存续的持仓. 方法为:

1. 最后到期日 还大于等于 T日

2. 平仓日期  还大于等于 T日  (防止提前平仓)

3. 结算日期 还大于等于T 日  (防止提前行权)

4. 开始日期 大于T 日。(由于T 日可以是历史回溯，逻辑完备)

### 1.2 T日持仓，再次分类

(一) T日了结
1. T 日是最后到日期的。 

2. T 日是平仓日期的

3. T 日是结算日期的

(二) T日非了结

1. 当日建仓

2. 非当日建仓

以上对应了5种状态，[存续， 到期， 新增， 先平， 先结]

## 2.常规算法

Daily的盈亏 = 今日收盘价的估值 - 昨日收盘价的估值
估值采用Generic BS公式，参数：（C/P， Price, 行权价, 剩余交易天数/245, 利率, 入场波动率)


## 3.非常规算法

### 3.1 人工提供估值

1. 标的是价差
2. 远期
3. 奇异，亚欧
4. 互换

### 3.2 非常规，但不需要人工提供,或需要人工注意

1. 当日到期的， 今日估值为0， 昨日估值为BS
2. 当日平仓的， 今日估值为 人工填写(平仓价), 昨日估值为BS
3. 当日行权的， 今日估值为 人工填写，  昨日估值为BS
4. 开始日期为今天的， 今日估值为BS， 昨日估值为  单位权利金，即入场价

## 4.汇总

程序要记录好 起始行，终止行，

见某一日的报表
